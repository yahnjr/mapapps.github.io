<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Add Points to Feature Layer</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    #viewDiv {
      height: 80vh;
      width: 100%;
      margin: 0;
      padding: 0;
      position: relative;
    }

    .topic-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
    }

    .topic-button {
      margin-bottom: 5px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #eee;
      border: 1px solid #ddd;    
    }

    .topic-button.selected-topic {
      background-color: #ddd;
    }

    .esri-geometry-point {
      outline: none; 
      width: 5px;
      height: 5px;
    }

    .welcome-box {
      position: absolute;
      top: 50%;
      left: 50%;
      background-color: white;
      padding: 10px;
      border: 1px solid #ddd;
      z-index: 1;
      max-width: 300px;
      height: 200px;
      font-size: 11px;
    }
    
    @media only screen and (min-width: 768px) {
    .welcome-box {
      font-size: 16px;
    }

    .close-button {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 20px;
    }

    .info-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      cursor: pointer;
    }
  }
  </style>
</head>
<body>
  <div id="viewDiv">
    <div class="welcome-box">
      <!-- Add custom welcome message -->
      <p>Welcome! Please select a topic from the top right and double-click anywhere on the map to add a point. Click "Submit" to save your points to the server.</p>
      <span class="close-button" onclick="document.querySelector('.welcome-box').style.display = 'none'">x</span>
    </div>
  </div>
  <div class="topic-buttons">
    <!-- Add custom topics -->
    <div class="topic-button" id="housing">ðŸŸ¡ Housing</div>
    <div class="topic-button" id="employment">ðŸ”´ Employment</div>
  </div>
  <button id="submitButton" class="info-button">Submit</button>
  
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/renderers/UniqueValueRenderer",
      "esri/renderers/HeatmapRenderer",
      "esri/widgets/BasemapToggle",
      "esri/Basemap"
    ], function(Map, MapView, FeatureLayer, Graphic, SimpleMarkerSymbol, UniqueValueRenderer, HeatmapRenderer, BasemapToggle, Basemap) {
      var map = new Map({
        basemap: "topo-vector"
      });

      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: ["-123", "45.578"], // Replace with actual coordinates
        zoom: 13 
      });

      // Placeholder feature layer URL (replace with your actual editable comments layer)
      var featureLayerUrl = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/NorthPlainsUGBRelook/FeatureServer";

      // Create feature layer
      var featureLayer = new FeatureLayer({
        url: featureLayerUrl,
        outFields: ["*"],
        editable: true, 
      });

      map.add(featureLayer);

      // Define the symbol for each topic
      var heatmapRenderer = new HeatmapRenderer({
        field: "topic", // Apply different heatmaps based on the topic
        colorStops: [
          {
            ratio: 0, // Starting ratio
            color: "rgba(255, 255, 0, 0)" // Transparent for "Housing"
          },
          {
            ratio: 0.5,
            color: "rgba(255, 255, 31, 0.7)" // Yellow for Housing
          },
          {
            ratio: 1, // Maximum ratio
            color: "rgba(255, 255, 31, 1)" // Intense yellow
          },
          {
            ratio: 0,
            color: "rgba(255, 0, 0, 0)" // Transparent for Employment
          },
          {
            ratio: 0.5,
            color: "rgba(193, 66, 104, 0.7)" // Red for Employment
          },
          {
            ratio: 1,
            color: "rgba(193, 66, 104, 1)" // Intense red
          }
        ],
        radius: 10,
        maxDensity: 1, 
        minDensity: 0
      });

      featureLayer.renderer = heatmapRenderer;

      // Apply the renderer to the feature layer
      featureLayer.renderer = heatmapRenderer;

      // Add a polygon layer, if needed
      // var polygonLayerUrl = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/North_Plains_UGB/FeatureServer/3";
      // var polygonLayer = new FeatureLayer({
      //   url: polygonLayerUrl,
      //   renderer: {
      //     type: "simple",
      //     symbol: {
      //       type: "simple-fill",
      //       color: [0, 0, 255, 0], 
      //       outline: {
      //         color: [255, 0, 0, 1], 
      //         width: 2 
      //       }
      //     }
      //   }
      // });

      // map.add(polygonLayer);

      // To store points added temporarily
      var tempGraphics = [];

      // Listen for double-click event to add points/comments
      view.on("double-click", function(event) {
        event.stopPropagation();
        
        var point = {
          type: "point",
          longitude: event.mapPoint.longitude,
          latitude: event.mapPoint.latitude
        };

        var selectedTopic = document.querySelector(".selected-topic");
        if (!selectedTopic) {
          alert("Please select a topic before adding a point.");
          return;
        }

        var attributes = {
          topic: selectedTopic.id.charAt(0).toUpperCase() + selectedTopic.id.slice(1)
        };

        var newGraphic = new Graphic({
          geometry: point,
          attributes: attributes
        });

        tempGraphics.push(newGraphic);
        view.graphics.add(newGraphic); // Show point temporarily
      });

      // Add event listeners for topic buttons
      var topicButtons = document.querySelectorAll(".topic-button");
      topicButtons.forEach(function(button) {
        button.addEventListener("click", function() {
          topicButtons.forEach(function(btn) {
            btn.classList.remove("selected-topic");
          });
          button.classList.add("selected-topic");
        });
      });

      // Submit button - send all temp points to the feature layer
      document.getElementById("submitButton").addEventListener("click", function() {
        if (tempGraphics.length > 0) {
          featureLayer.applyEdits({
            addFeatures: tempGraphics
          }).then(function(response) {
            console.log("Points submitted successfully:", response);
            tempGraphics = []; // Clear the temp points array after submission
            view.graphics.removeAll(); // Clear temp graphics from the map
            alert("Points have been submitted successfully!");
          }).catch(function(error) {
            console.error("Error submitting points:", error);
            alert("Error submitting points. Please try again.");
          });
        } else {
          alert("No points to submit.");
        }
      });

      // Basemap toggle widget
      var toggle = new BasemapToggle({
        view: view,
        nextBasemap: "hybrid" 
      });

      view.ui.add(toggle, "bottom-left");
    });
  </script>
</body>
</html>
